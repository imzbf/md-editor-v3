import{e as Y,q as te,z,r as V,aG as J,A as le,f as Z,s as oe,v as ne,b as N,ae as ie,p as B,l as K,B as se,aH as ae,am as re}from"./1vdjpMrM.js";import{b as W,i as Q,G as X,P as ce,S as de,j as fe}from"./DbIwxZXY.js";const ue=`.${B}-preview > [data-line]`,j=(e,o)=>+getComputedStyle(e).getPropertyValue(o).replace("px",""),Te=(e,o)=>{const p=ae(()=>{e.removeEventListener("scroll",i),e.addEventListener("scroll",i),o.removeEventListener("scroll",i),o.addEventListener("scroll",i)},50),i=s=>{const T=e.clientHeight,k=o.clientHeight,u=e.scrollHeight,a=o.scrollHeight,m=(u-T)/(a-k);s.target===e?(o.removeEventListener("scroll",i),o.scrollTo({top:e.scrollTop/m}),p()):(e.removeEventListener("scroll",i),e.scrollTo({top:o.scrollTop*m}),p())};return[()=>{p().finally(()=>{e.dispatchEvent(new Event("scroll"))})},()=>{e.removeEventListener("scroll",i),o.removeEventListener("scroll",i)}]},He=(e,o,p)=>{const{view:i}=p,s=re(),T=d=>i.lineBlockAt(i.state.doc.line(d+1).from).top,k=d=>i.lineBlockAt(i.state.doc.line(d+1).from).bottom;let u=[],a=[],m=[];const S=()=>{u=[],a=Array.from(o.querySelectorAll(ue)),m=a.map(n=>Number(n.dataset.line));const d=[...m],{lines:g}=i.state.doc;let l=d.shift()||0,t=d.shift()||g;for(let n=0;n<g;n++)n===t&&(l=n,t=d.shift()||g),u.push({start:l,end:t-1})},L=(d,g)=>{let l=1;for(let t=a.length-1;t-1>=0;t--){const n=a[t],c=a[t-1];if(n.offsetTop+n.offsetHeight>g&&c.offsetTop<g){l=Number(c.dataset.line);break}}for(let t=u.length-1;t>=0;t--){const n=k(u[t].end),c=T(u[t].start);if(n>d&&c<=d){l=l<u[t].start?l:u[t].start;break}}return l};let H=0,M=0;const P=()=>{var d,g,l;if(M!==0)return!1;H++;const{scrollDOM:t,contentHeight:n}=i;let c=j(o,"padding-top");const b=i.lineBlockAtHeight(t.scrollTop),{number:C}=i.state.doc.lineAt(b.from),v=u[C-1];if(!v)return!1;let f=1;const I=o.querySelector(`[data-line="${v.start}"]`)||((d=o.firstElementChild)==null?void 0:d.firstElementChild),r=o.querySelector(`[data-line="${v.end+1}"]`)||((g=o.lastElementChild)==null?void 0:g.lastElementChild),E=t.scrollHeight-t.clientHeight,A=o.scrollHeight-o.clientHeight;let _=T(v.start),R=k(v.end),D=I.offsetTop,w=r.offsetTop-D;_===0&&(D=0,I===r?(c=0,R=n-t.offsetHeight,w=A):w=r.offsetTop),f=(t.scrollTop-_)/(R-_);const q=r==((l=o.lastElementChild)==null?void 0:l.lastElementChild)?r.offsetTop+r.clientHeight:r.offsetTop;if(R>=E||q>A){const $=L(E,A);_=T($),f=(t.scrollTop-_)/(E-_);const x=o.querySelector(`[data-line="${$}"]`);_>0&&x&&(D=x.offsetTop),w=A-D+j(o,"padding-top")}const G=D-c+w*f;s(o,G,()=>{H--})},F=()=>{var d,g,l,t,n,c;if(H!==0)return;M++;const{scrollDOM:b}=i,C=o.scrollTop,v=o.scrollHeight,f=b.scrollHeight-b.clientHeight,I=o.scrollHeight-o.clientHeight;let r=(d=o.firstElementChild)==null?void 0:d.firstElementChild,E=(g=o.firstElementChild)==null?void 0:g.lastElementChild;if(m.length>0){let x=Math.ceil(m[m.length-1]*(C/v)),h=m.findLastIndex(y=>y<=x);h=h===-1?0:h,x=m[h];for(let y=h;y>=0&&y<m.length;)if(a[y].offsetTop>C){if(y-1>=0){y--;continue}x=-1,h=y;break}else{if(y+1<m.length&&a[y+1].offsetTop<C){y++;continue}x=m[y],h=y;break}switch(h){case-1:{r=(l=o.firstElementChild)==null?void 0:l.firstElementChild,E=a[h];break}case m.length-1:{r=a[h],E=(t=o.firstElementChild)==null?void 0:t.lastElementChild;break}default:r=a[h],E=a[h+1===a.length?h:h+1]}}let A=r===((n=o.firstElementChild)==null?void 0:n.firstElementChild)?0:r.offsetTop-j(r,"margin-top"),_=E.offsetTop,R=0;const{start:D,end:w}=u[Number(r.dataset.line||0)];let q=T(D);const G=T(w+1===i.state.doc.lines?w:w+1);let $=0;if(G>f||E.offsetTop+E.offsetHeight>I){const x=L(f,I),h=o.querySelector(`[data-line="${x}"]`);A=h?h.offsetTop-j(h,"margin-top"):A,q=T(x),R=(C-A)/(I-A),$=f-q}else r===((c=o.firstElementChild)==null?void 0:c.firstElementChild)?(r===E&&(_=E.offsetTop+E.offsetHeight+ +getComputedStyle(E).marginBottom.replace("px","")),$=G,R=Math.max(C/_,0)):(R=Math.max((C-A)/(_-A),0),$=G-q);s(e,q+$*R,()=>{M--})},O=d=>{var g;const{scrollDOM:l,contentHeight:t}=i,n=l.clientHeight;if(t<=n||o.firstElementChild.clientHeight<=o.clientHeight||i.state.doc.lines<=((g=u[u.length-1])==null?void 0:g.end))return!1;d.target===e?P():F()};return[()=>{S(),e.addEventListener("scroll",O),o.addEventListener("scroll",O),e.dispatchEvent(new Event("scroll"))},()=>{e.removeEventListener("scroll",O),o.removeEventListener("scroll",O)}]},me={tocItem:{type:Object,default:()=>({})},mdHeadingId:{type:Function,default:()=>{}},onActive:{type:Function,default:()=>{}},onClick:{type:Function,default:()=>{}},scrollElementOffsetTop:{type:Number,default:0}},ee=Y({props:me,setup(e){const o=K("scrollElementRef"),p=K("roorNodeRef"),i=V();return Z(()=>e.tocItem.active,s=>{s&&(i.value?e.onActive(e.tocItem,i.value):se(()=>{e.onActive(e.tocItem,i.value)}))},{immediate:!0}),()=>{const{tocItem:s,mdHeadingId:T,onClick:k,scrollElementOffsetTop:u}=e;return N("div",{ref:i,class:[`${B}-catalog-link`,s.active&&`${B}-catalog-active`],onClick:a=>{if(a.stopPropagation(),k(a,s),a.defaultPrevented)return;const m=T(s.text,s.level,s.index),S=p.value.getElementById(m),L=o.value;if(S&&L){let H=S.offsetParent,M=S.offsetTop;if(L.contains(H))for(;H&&L!=H;)M+=H==null?void 0:H.offsetTop,H=H==null?void 0:H.offsetParent;const P=S.previousElementSibling;let F=0;P||(F=j(S,"margin-top")),L==null||L.scrollTo({top:M-u-F,behavior:"smooth"})}}},[N("span",{title:s.text},[s.text]),s.children&&s.children.length>0&&N("div",{class:`${B}-catalog-wrapper`},[s.children.map(a=>N(ee,{mdHeadingId:T,key:`${s.text}-link-${a.level}-${a.text}`,tocItem:a,onActive:e.onActive,onClick:k,scrollElementOffsetTop:u},null))])])}}}),ve={editorId:{type:String,default:void 0},class:{type:String,default:""},mdHeadingId:{type:Function,default:e=>e},scrollElement:{type:[String,Object],default:void 0},theme:{type:String,default:"light"},offsetTop:{type:Number,default:20},scrollElementOffsetTop:{type:Number,default:0},onClick:{type:Function,default:void 0},onActive:{type:Function,default:void 0},isScrollElementInShadow:{type:Boolean,default:!1},syncWith:{type:String,default:"preview"},catalogMaxDepth:{type:Number,default:void 0}},U=Y({name:"MdCatalog",props:ve,emits:["onClick","onActive"],setup(e,o){const p=e.editorId,i=`#${p}-preview-wrapper`,s=te({list:[],show:!1,scrollElement:e.scrollElement||i}),T=z(),k=V(),u=V(),a=V(),m=V(),S=z(),L=V({});J("scrollElementRef",u),J("roorNodeRef",m);const H=le(()=>{const l=[];return s.list.forEach((t,n)=>{if(e.catalogMaxDepth&&t.level>e.catalogMaxDepth)return;const{text:c,level:b,line:C}=t,v={level:b,text:c,line:C,index:n+1,active:T.value===t};if(l.length===0)l.push(v);else{let f=l[l.length-1];if(v.level>f.level)for(let I=f.level+1;I<=6;I++){const{children:r}=f;if(!r){f.children=[v];break}if(f=r[r.length-1],v.level<=f.level){r.push(v);break}}else l.push(v)}}),l}),M=()=>{var l;if(s.scrollElement instanceof HTMLElement)return s.scrollElement;let t=document;return(s.scrollElement===i||e.isScrollElementInShadow)&&(t=(l=k.value)==null?void 0:l.getRootNode()),t.querySelector(s.scrollElement)},P=l=>{if(l.length===0)return T.value=void 0,s.list=[],!1;const{activeHead:t}=l.reduce((n,c,b)=>{var C;let v=0;if(e.syncWith==="preview"){const f=(C=m.value)==null?void 0:C.getElementById(e.mdHeadingId(c.text,c.level,b+1));f instanceof HTMLElement&&(v=fe(f,u.value))}else{const f=S.value;if(f){const I=f.lineBlockAt(f.state.doc.line(c.line+1).from).top,r=f.scrollDOM.scrollTop;v=I-r}}return v<e.offsetTop&&v>n.minTop?{activeHead:c,minTop:v}:n},{activeHead:l[0],minTop:Number.MIN_SAFE_INTEGER});T.value=t,s.list=l},F=(l,t)=>{var n;L.value.top=t.offsetTop+j(t,"padding-top")+"px",(n=e.onActive)==null||n.call(e,l,t),o.emit("onActive",l,t)},O=()=>{P(s.list)},d=l=>{var t,n,c;if((t=a.value)==null||t.removeEventListener("scroll",O),e.syncWith==="editor")a.value=(n=S.value)==null?void 0:n.scrollDOM;else{const b=M();u.value=b,a.value=b===document.documentElement?document:b}P(l),(c=a.value)==null||c.addEventListener("scroll",O)},g=l=>{S.value=l};return Z([()=>e.syncWith,S,()=>e.catalogMaxDepth],()=>{d(s.list)}),oe(()=>{m.value=k.value.getRootNode(),W.on(p,{name:Q,callback:d}),W.on(p,{name:X,callback:g}),W.emit(p,ce),W.emit(p,de)}),ne(()=>{var l;W.remove(p,Q,d),W.remove(p,X,g),(l=a.value)==null||l.removeEventListener("scroll",O)}),()=>N("div",{class:[`${B}-catalog`,e.theme==="dark"&&`${B}-catalog-dark`,e.class||""],ref:k},[H.value.length>0&&N(ie,null,[N("div",{class:`${B}-catalog-indicator`,style:L.value},null),N("div",{class:`${B}-catalog-container`},[H.value.map(l=>N(ee,{mdHeadingId:e.mdHeadingId,tocItem:l,key:`link-${l.level}-${l.text}`,onActive:F,onClick:(t,n)=>{var c;(c=e.onClick)==null||c.call(e,t,n),o.emit("onClick",t,n)},scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])])}});U.install=e=>(e.component(U.name,U),e);export{U as M,Te as a,He as s};
