import{e as Y,q as te,z,r as V,aG as J,A as le,f as Z,s as oe,v as ne,b as x,ae as se,p as B,l as K,B as ie,aH as re,am as ae}from"./D9HhdxFL.js";import{b as W,i as Q,G as X,P as ce,S as de,j as fe}from"./qIvSjFgj.js";const ue=`.${B}-preview > [data-line]`,j=(e,o)=>+getComputedStyle(e).getPropertyValue(o).replace("px",""),Te=(e,o)=>{const p=re(()=>{e.removeEventListener("scroll",s),e.addEventListener("scroll",s),o.removeEventListener("scroll",s),o.addEventListener("scroll",s)},50),s=i=>{const T=e.clientHeight,k=o.clientHeight,u=e.scrollHeight,r=o.scrollHeight,m=(u-T)/(r-k);i.target===e?(o.removeEventListener("scroll",s),o.scrollTo({top:e.scrollTop/m}),p()):(e.removeEventListener("scroll",s),e.scrollTo({top:o.scrollTop*m}),p())};return[()=>{p().finally(()=>{e.dispatchEvent(new Event("scroll"))})},()=>{e.removeEventListener("scroll",s),o.removeEventListener("scroll",s)}]},He=(e,o,p)=>{const{view:s}=p,i=ae(),T=d=>s.lineBlockAt(s.state.doc.line(d+1).from).top,k=d=>s.lineBlockAt(s.state.doc.line(d+1).from).bottom;let u=[],r=[],m=[];const S=()=>{u=[],r=Array.from(o.querySelectorAll(ue)),m=r.map(n=>Number(n.dataset.line));const d=[...m],{lines:g}=s.state.doc;let l=d.shift()||0,t=d.shift()||g;for(let n=0;n<g;n++)n===t&&(l=n,t=d.shift()||g),u.push({start:l,end:t-1})},L=(d,g)=>{let l=1;for(let t=r.length-1;t-1>=0;t--){const n=r[t],c=r[t-1];if(n.offsetTop+n.offsetHeight>g&&c.offsetTop<g){l=Number(c.dataset.line);break}}for(let t=u.length-1;t>=0;t--){const n=k(u[t].end),c=T(u[t].start);if(n>d&&c<=d){l=l<u[t].start?l:u[t].start;break}}return l};let H=0,O=0;const P=()=>{var d,g,l;if(O!==0)return!1;H++;const{scrollDOM:t,contentHeight:n}=s;let c=j(o,"padding-top");const b=s.lineBlockAtHeight(t.scrollTop),{number:C}=s.state.doc.lineAt(b.from),v=u[C-1];if(!v)return!1;let f=1;const I=o.querySelector(`[data-line="${v.start}"]`)||((d=o.firstElementChild)==null?void 0:d.firstElementChild),a=o.querySelector(`[data-line="${v.end+1}"]`)||((g=o.lastElementChild)==null?void 0:g.lastElementChild),E=t.scrollHeight-t.clientHeight,A=o.scrollHeight-o.clientHeight;let _=T(v.start),M=k(v.end),D=I.offsetTop,w=a.offsetTop-D;_===0&&(D=0,I===a?(c=0,M=n-t.offsetHeight,w=A):w=a.offsetTop),f=(t.scrollTop-_)/(M-_);const q=a==((l=o.lastElementChild)==null?void 0:l.lastElementChild)?a.offsetTop+a.clientHeight:a.offsetTop;if(M>=E||q>A){const $=L(E,A);_=T($),f=(t.scrollTop-_)/(E-_);const N=o.querySelector(`[data-line="${$}"]`);_>0&&N&&(D=N.offsetTop),w=A-D+j(o,"padding-top")}const G=D-c+w*f;i(o,G,()=>{H--})},F=()=>{var d,g,l,t,n,c;if(H!==0)return;O++;const{scrollDOM:b}=s,C=o.scrollTop,v=o.scrollHeight,f=b.scrollHeight-b.clientHeight,I=o.scrollHeight-o.clientHeight;let a=(d=o.firstElementChild)==null?void 0:d.firstElementChild,E=(g=o.firstElementChild)==null?void 0:g.lastElementChild;if(m.length>0){let N=Math.ceil(m[m.length-1]*(C/v)),h=m.findLastIndex(y=>y<=N);h=h===-1?0:h,N=m[h];for(let y=h;y>=0&&y<m.length;)if(r[y].offsetTop>C){if(y-1>=0){y--;continue}N=-1,h=y;break}else{if(y+1<m.length&&r[y+1].offsetTop<C){y++;continue}N=m[y],h=y;break}switch(h){case-1:{a=(l=o.firstElementChild)==null?void 0:l.firstElementChild,E=r[h];break}case m.length-1:{a=r[h],E=(t=o.firstElementChild)==null?void 0:t.lastElementChild;break}default:a=r[h],E=r[h+1===r.length?h:h+1]}}let A=a===((n=o.firstElementChild)==null?void 0:n.firstElementChild)?0:a.offsetTop-j(a,"margin-top"),_=E.offsetTop,M=0;const{start:D,end:w}=u[Number(a.dataset.line||0)];let q=T(D);const G=T(w+1===s.state.doc.lines?w:w+1);let $=0;if(G>f||E.offsetTop+E.offsetHeight>I){const N=L(f,I),h=o.querySelector(`[data-line="${N}"]`);A=h?h.offsetTop-j(h,"margin-top"):A,q=T(N),M=(C-A)/(I-A),$=f-q}else a===((c=o.firstElementChild)==null?void 0:c.firstElementChild)?(a===E&&(_=E.offsetTop+E.offsetHeight+ +getComputedStyle(E).marginBottom.replace("px","")),$=G,M=Math.max(C/_,0)):(M=Math.max((C-A)/(_-A),0),$=G-q);i(e,q+$*M,()=>{O--})},R=d=>{var g;const{scrollDOM:l,contentHeight:t}=s,n=l.clientHeight;if(t<=n||o.firstElementChild.clientHeight<=o.clientHeight||s.state.doc.lines<=((g=u[u.length-1])==null?void 0:g.end))return!1;d.target===e?P():F()};return[()=>{S(),e.addEventListener("scroll",R),o.addEventListener("scroll",R),e.dispatchEvent(new Event("scroll"))},()=>{e.removeEventListener("scroll",R),o.removeEventListener("scroll",R)}]},me={tocItem:{type:Object,default:()=>({})},mdHeadingId:{type:Function,default:()=>{}},onActive:{type:Function,default:()=>{}},onClick:{type:Function,default:()=>{}},scrollElementOffsetTop:{type:Number,default:0}},ee=Y({props:me,setup(e){const o=K("scrollElementRef"),p=K("roorNodeRef"),s=V();return Z(()=>e.tocItem.active,i=>{i&&(s.value?e.onActive(e.tocItem,s.value):ie(()=>{e.onActive(e.tocItem,s.value)}))},{immediate:!0}),()=>{const{tocItem:i,mdHeadingId:T,onClick:k,scrollElementOffsetTop:u}=e;return x("div",{ref:s,class:[`${B}-catalog-link`,i.active&&`${B}-catalog-active`],onClick:r=>{if(r.stopPropagation(),k(r,i),r.defaultPrevented)return;const m=T(i.text,i.level,i.index),S=p.value.getElementById(m),L=o.value;if(S&&L){let H=S.offsetParent,O=S.offsetTop;if(L.contains(H))for(;H&&L!=H;)O+=H==null?void 0:H.offsetTop,H=H==null?void 0:H.offsetParent;const P=S.previousElementSibling;let F=0;P||(F=j(S,"margin-top")),L==null||L.scrollTo({top:O-u-F,behavior:"smooth"})}}},[x("span",{title:i.text},[i.text]),i.children&&i.children.length>0&&x("div",{class:`${B}-catalog-wrapper`},[i.children.map(r=>x(ee,{mdHeadingId:T,key:`${i.text}-link-${r.level}-${r.text}`,tocItem:r,onActive:e.onActive,onClick:k,scrollElementOffsetTop:u},null))])])}}}),ve={editorId:{type:String,default:void 0},class:{type:String,default:""},mdHeadingId:{type:Function,default:e=>e},scrollElement:{type:[String,Object],default:void 0},theme:{type:String,default:"light"},offsetTop:{type:Number,default:20},scrollElementOffsetTop:{type:Number,default:0},onClick:{type:Function,default:void 0},onActive:{type:Function,default:void 0},isScrollElementInShadow:{type:Boolean,default:!1},syncWith:{type:String,default:"preview"}},U=Y({name:"MdCatalog",props:ve,emits:["onClick","onActive"],setup(e,o){const p=e.editorId,s=`#${p}-preview-wrapper`,i=te({list:[],show:!1,scrollElement:e.scrollElement||s}),T=z(),k=V(),u=V(),r=V(),m=V(),S=z(),L=V({});J("scrollElementRef",u),J("roorNodeRef",m);const H=le(()=>{const l=[];return i.list.forEach((t,n)=>{const{text:c,level:b,line:C}=t,v={level:b,text:c,line:C,index:n+1,active:T.value===t};if(l.length===0)l.push(v);else{let f=l[l.length-1];if(v.level>f.level)for(let I=f.level+1;I<=6;I++){const{children:a}=f;if(!a){f.children=[v];break}if(f=a[a.length-1],v.level<=f.level){a.push(v);break}}else l.push(v)}}),l}),O=()=>{var l;if(i.scrollElement instanceof HTMLElement)return i.scrollElement;let t=document;return(i.scrollElement===s||e.isScrollElementInShadow)&&(t=(l=k.value)==null?void 0:l.getRootNode()),t.querySelector(i.scrollElement)},P=l=>{if(l.length===0)return T.value=void 0,i.list=[],!1;const{activeHead:t}=l.reduce((n,c,b)=>{var C;let v=0;if(e.syncWith==="preview"){const f=(C=m.value)==null?void 0:C.getElementById(e.mdHeadingId(c.text,c.level,b+1));f instanceof HTMLElement&&(v=fe(f,u.value))}else{const f=S.value;if(f){const I=f.lineBlockAt(f.state.doc.line(c.line+1).from).top,a=f.scrollDOM.scrollTop;v=I-a}}return v<e.offsetTop&&v>n.minTop?{activeHead:c,minTop:v}:n},{activeHead:l[0],minTop:Number.MIN_SAFE_INTEGER});T.value=t,i.list=l},F=(l,t)=>{var n;L.value.top=t.offsetTop+j(t,"padding-top")+"px",(n=e.onActive)==null||n.call(e,l,t),o.emit("onActive",l,t)},R=()=>{P(i.list)},d=l=>{var t,n,c;if((t=r.value)==null||t.removeEventListener("scroll",R),e.syncWith==="editor")r.value=(n=S.value)==null?void 0:n.scrollDOM;else{const b=O();u.value=b,r.value=b===document.documentElement?document:b}P(l),(c=r.value)==null||c.addEventListener("scroll",R)},g=l=>{S.value=l};return Z([()=>e.syncWith,S],()=>{d(i.list)}),oe(()=>{m.value=k.value.getRootNode(),W.on(p,{name:Q,callback:d}),W.on(p,{name:X,callback:g}),W.emit(p,ce),W.emit(p,de)}),ne(()=>{var l;W.remove(p,Q,d),W.remove(p,X,g),(l=r.value)==null||l.removeEventListener("scroll",R)}),()=>x("div",{class:[`${B}-catalog`,e.theme==="dark"&&`${B}-catalog-dark`,e.class||""],ref:k},[H.value.length>0&&x(se,null,[x("div",{class:`${B}-catalog-indicator`,style:L.value},null),x("div",{class:`${B}-catalog-container`},[H.value.map(l=>x(ee,{mdHeadingId:e.mdHeadingId,tocItem:l,key:`link-${l.level}-${l.text}`,onActive:F,onClick:(t,n)=>{var c;(c=e.onClick)==null||c.call(e,t,n),o.emit("onClick",t,n)},scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])])}});U.install=e=>(e.component(U.name,U),e);export{U as M,Te as a,He as s};
