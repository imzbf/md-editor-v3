import{h as Y,r as le,s as z,q as V,f as oe,v as Z,j as ee,x as ne,b as N,ac as ie,p as D,l as J,aD as se,ag as ae,aE as K}from"./DGjGxhwD.js";import{b as G,i as Q,G as X,P as re,S as ce,j as de}from"./WRgaV5N2.js";const fe=`.${D}-preview > [data-line]`,j=(e,o)=>+getComputedStyle(e).getPropertyValue(o).replace("px",""),pe=(e,o)=>{const p=se(()=>{e.removeEventListener("scroll",i),e.addEventListener("scroll",i),o.removeEventListener("scroll",i),o.addEventListener("scroll",i)},50),i=s=>{const T=e.clientHeight,L=o.clientHeight,u=e.scrollHeight,a=o.scrollHeight,v=(u-T)/(a-L);s.target===e?(o.removeEventListener("scroll",i),o.scrollTo({top:e.scrollTop/v}),p()):(e.removeEventListener("scroll",i),e.scrollTo({top:o.scrollTop*v}),p())};return[()=>{p().finally(()=>{e.dispatchEvent(new Event("scroll"))})},()=>{e.removeEventListener("scroll",i),o.removeEventListener("scroll",i)}]},Te=(e,o,p)=>{const{view:i}=p,s=ae(),T=d=>i.lineBlockAt(i.state.doc.line(d+1).from).top,L=d=>i.lineBlockAt(i.state.doc.line(d+1).from).bottom;let u=[],a=[],v=[];const S=()=>{u=[],a=Array.from(o.querySelectorAll(fe)),v=a.map(n=>Number(n.dataset.line));const d=[...v],{lines:g}=i.state.doc;let l=d.shift()||0,t=d.shift()||g;for(let n=0;n<g;n++)n===t&&(l=n,t=d.shift()||g),u.push({start:l,end:t-1})},k=(d,g)=>{let l=1;for(let t=a.length-1;t-1>=0;t--){const n=a[t],c=a[t-1];if(n.offsetTop+n.offsetHeight>g&&c.offsetTop<g){l=Number(c.dataset.line);break}}for(let t=u.length-1;t>=0;t--){const n=L(u[t].end),c=T(u[t].start);if(n>d&&c<=d){l=l<u[t].start?l:u[t].start;break}}return l};let H=0,M=0;const P=()=>{var d,g,l;if(M!==0)return!1;H++;const{scrollDOM:t,contentHeight:n}=i;let c=j(o,"padding-top");const b=i.lineBlockAtHeight(t.scrollTop),{number:C}=i.state.doc.lineAt(b.from),m=u[C-1];if(!m)return!1;let f=1;const I=o.querySelector(`[data-line="${m.start}"]`)||((d=o.firstElementChild)==null?void 0:d.firstElementChild),r=o.querySelector(`[data-line="${m.end+1}"]`)||((g=o.lastElementChild)==null?void 0:g.lastElementChild),E=t.scrollHeight-t.clientHeight,_=o.scrollHeight-o.clientHeight;let A=T(m.start),R=L(m.end),B=I.offsetTop,w=r.offsetTop-B;A===0&&(B=0,I===r?(c=0,R=n-t.offsetHeight,w=_):w=r.offsetTop),f=(t.scrollTop-A)/(R-A);const q=r==((l=o.lastElementChild)==null?void 0:l.lastElementChild)?r.offsetTop+r.clientHeight:r.offsetTop;if(R>=E||q>_){const $=k(E,_);A=T($),f=(t.scrollTop-A)/(E-A);const x=o.querySelector(`[data-line="${$}"]`);A>0&&x&&(B=x.offsetTop),w=_-B+j(o,"padding-top")}const W=B-c+w*f;s(o,W,()=>{H--})},F=()=>{var d,g,l,t,n,c;if(H!==0)return;M++;const{scrollDOM:b}=i,C=o.scrollTop,m=o.scrollHeight,f=b.scrollHeight-b.clientHeight,I=o.scrollHeight-o.clientHeight;let r=(d=o.firstElementChild)==null?void 0:d.firstElementChild,E=(g=o.firstElementChild)==null?void 0:g.lastElementChild;if(v.length>0){let x=Math.ceil(v[v.length-1]*(C/m)),h=v.findLastIndex(y=>y<=x);h=h===-1?0:h,x=v[h];for(let y=h;y>=0&&y<v.length;)if(a[y].offsetTop>C){if(y-1>=0){y--;continue}x=-1,h=y;break}else{if(y+1<v.length&&a[y+1].offsetTop<C){y++;continue}x=v[y],h=y;break}switch(h){case-1:{r=(l=o.firstElementChild)==null?void 0:l.firstElementChild,E=a[h];break}case v.length-1:{r=a[h],E=(t=o.firstElementChild)==null?void 0:t.lastElementChild;break}default:r=a[h],E=a[h+1===a.length?h:h+1]}}let _=r===((n=o.firstElementChild)==null?void 0:n.firstElementChild)?0:r.offsetTop-j(r,"margin-top"),A=E.offsetTop,R=0;const{start:B,end:w}=u[Number(r.dataset.line||0)];let q=T(B);const W=T(w+1===i.state.doc.lines?w:w+1);let $=0;if(W>f||E.offsetTop+E.offsetHeight>I){const x=k(f,I),h=o.querySelector(`[data-line="${x}"]`);_=h?h.offsetTop-j(h,"margin-top"):_,q=T(x),R=(C-_)/(I-_),$=f-q}else r===((c=o.firstElementChild)==null?void 0:c.firstElementChild)?(r===E&&(A=E.offsetTop+E.offsetHeight+ +getComputedStyle(E).marginBottom.replace("px","")),$=W,R=Math.max(C/A,0)):(R=Math.max((C-_)/(A-_),0),$=W-q);s(e,q+$*R,()=>{M--})},O=d=>{var g;const{scrollDOM:l,contentHeight:t}=i,n=l.clientHeight;if(t<=n||o.firstElementChild.clientHeight<=o.clientHeight||i.state.doc.lines<=((g=u[u.length-1])==null?void 0:g.end))return!1;d.target===e?P():F()};return[()=>{S(),e.addEventListener("scroll",O),o.addEventListener("scroll",O),e.dispatchEvent(new Event("scroll"))},()=>{e.removeEventListener("scroll",O),o.removeEventListener("scroll",O)}]},ue={tocItem:{type:Object,default:()=>({})},mdHeadingId:{type:Function,default:()=>{}},onActive:{type:Function,default:()=>{}},onClick:{type:Function,default:()=>{}},scrollElementOffsetTop:{type:Number,default:0}},te=Y({props:ue,setup(e){const o=J("scrollElementRef"),p=J("roorNodeRef"),i=V();return Z(()=>e.tocItem.active,s=>{s&&e.onActive(e.tocItem,i.value)}),ee(()=>{e.tocItem.active&&e.onActive(e.tocItem,i.value)}),()=>{const{tocItem:s,mdHeadingId:T,onClick:L,scrollElementOffsetTop:u}=e;return N("div",{ref:i,class:[`${D}-catalog-link`,s.active&&`${D}-catalog-active`],onClick:a=>{if(a.stopPropagation(),L(a,s),a.defaultPrevented)return;const v=T(s.text,s.level,s.index),S=p.value.getElementById(v),k=o.value;if(S&&k){let H=S.offsetParent,M=S.offsetTop;if(k.contains(H))for(;H&&k!=H;)M+=H==null?void 0:H.offsetTop,H=H==null?void 0:H.offsetParent;const P=S.previousElementSibling;let F=0;P||(F=j(S,"margin-top")),k==null||k.scrollTo({top:M-u-F,behavior:"smooth"})}}},[N("span",{title:s.text},[s.text]),s.children&&s.children.length>0&&N("div",{class:`${D}-catalog-wrapper`},[s.children.map(a=>N(te,{mdHeadingId:T,key:`${s.text}-link-${a.level}-${a.text}`,tocItem:a,onActive:e.onActive,onClick:L,scrollElementOffsetTop:u},null))])])}}}),ve={editorId:{type:String,default:void 0},class:{type:String,default:""},mdHeadingId:{type:Function,default:e=>e},scrollElement:{type:[String,Object],default:void 0},theme:{type:String,default:"light"},offsetTop:{type:Number,default:20},scrollElementOffsetTop:{type:Number,default:0},onClick:{type:Function,default:void 0},onActive:{type:Function,default:void 0},isScrollElementInShadow:{type:Boolean,default:!1},syncWith:{type:String,default:"preview"},catalogMaxDepth:{type:Number,default:void 0}},U=Y({name:"MdCatalog",props:ve,emits:["onClick","onActive"],setup(e,o){const p=e.editorId,i=`#${p}-preview-wrapper`,s=le({list:[],show:!1,scrollElement:e.scrollElement||i}),T=z(),L=V(),u=V(),a=V(),v=V(),S=z(),k=V({});K("scrollElementRef",u),K("roorNodeRef",v);const H=oe(()=>{const l=[];return s.list.forEach((t,n)=>{if(e.catalogMaxDepth&&t.level>e.catalogMaxDepth)return;const{text:c,level:b,line:C}=t,m={level:b,text:c,line:C,index:n+1,active:T.value===t};if(l.length===0)l.push(m);else{let f=l[l.length-1];if(m.level>f.level)for(let I=f.level+1;I<=6;I++){const{children:r}=f;if(!r){f.children=[m];break}if(f=r[r.length-1],m.level<=f.level){r.push(m);break}}else l.push(m)}}),l}),M=()=>{var l;if(s.scrollElement instanceof HTMLElement)return s.scrollElement;let t=document;return(s.scrollElement===i||e.isScrollElementInShadow)&&(t=(l=L.value)==null?void 0:l.getRootNode()),t.querySelector(s.scrollElement)},P=l=>{if(l.length===0)return T.value=void 0,s.list=[],!1;const{activeHead:t}=l.reduce((n,c,b)=>{var C;let m=0;if(e.syncWith==="preview"){const f=(C=v.value)==null?void 0:C.getElementById(e.mdHeadingId(c.text,c.level,b+1));f instanceof HTMLElement&&(m=de(f,u.value))}else{const f=S.value;if(f){const I=f.lineBlockAt(f.state.doc.line(c.line+1).from).top,r=f.scrollDOM.scrollTop;m=I-r}}return m<e.offsetTop&&m>n.minTop?{activeHead:c,minTop:m}:n},{activeHead:l[0],minTop:Number.MIN_SAFE_INTEGER});T.value=t,s.list=l},F=(l,t)=>{var n;k.value.top=t.offsetTop+j(t,"padding-top")+"px",(n=e.onActive)==null||n.call(e,l,t),o.emit("onActive",l,t)},O=()=>{P(s.list)},d=l=>{var t,n,c;if((t=a.value)==null||t.removeEventListener("scroll",O),e.syncWith==="editor")a.value=(n=S.value)==null?void 0:n.scrollDOM;else{const b=M();u.value=b,a.value=b===document.documentElement?document:b}P(l),(c=a.value)==null||c.addEventListener("scroll",O)},g=l=>{S.value=l};return Z([()=>e.syncWith,S,()=>e.catalogMaxDepth],()=>{d(s.list)}),ee(()=>{v.value=L.value.getRootNode(),G.on(p,{name:Q,callback:d}),G.on(p,{name:X,callback:g}),G.emit(p,re),G.emit(p,ce)}),ne(()=>{var l;G.remove(p,Q,d),G.remove(p,X,g),(l=a.value)==null||l.removeEventListener("scroll",O)}),()=>N("div",{class:[`${D}-catalog`,e.theme==="dark"&&`${D}-catalog-dark`,e.class||""],ref:L},[H.value.length>0&&N(ie,null,[N("div",{class:`${D}-catalog-indicator`,style:k.value},null),N("div",{class:`${D}-catalog-container`},[H.value.map(l=>N(te,{mdHeadingId:e.mdHeadingId,tocItem:l,key:`link-${l.level}-${l.text}`,onActive:F,onClick:(t,n)=>{var c;(c=e.onClick)==null||c.call(e,t,n),o.emit("onClick",t,n)},scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])])}});U.install=e=>(e.component(U.name,U),e);export{U as M,pe as a,Te as s};
