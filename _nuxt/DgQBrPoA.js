import{h as U,r as X,s as j,q as F,f as Y,v as z,j as J,x as Z,b as L,F as ee,p as w,l as _,aE as te,ae as le,aF as V}from"#entry";import{F as O,S as G,f as Q,H as oe,u as ne,g as ie}from"./CaH81vPM.js";const se=`.${w}-preview > [data-line]`,B=(e,l)=>+getComputedStyle(e).getPropertyValue(l).replace("px",""),de=(e,l)=>{const x=te(()=>{e.removeEventListener("scroll",n),e.addEventListener("scroll",n),l.removeEventListener("scroll",n),l.addEventListener("scroll",n)},50),n=H=>{const m=e.clientHeight,b=l.clientHeight,f=e.scrollHeight,r=l.scrollHeight,c=(f-m)/(r-b);H.target===e?(l.removeEventListener("scroll",n),l.scrollTo({top:e.scrollTop/c}),x()):(e.removeEventListener("scroll",n),e.scrollTo({top:l.scrollTop*c}),x())};return[()=>{x().finally(()=>{e.dispatchEvent(new Event("scroll"))})},()=>{e.removeEventListener("scroll",n),l.removeEventListener("scroll",n)}]},me=(e,l,x)=>{const{view:n}=x,H=le(),m=s=>n.lineBlockAt(n.state.doc.line(s+1).from).top,b=s=>n.lineBlockAt(n.state.doc.line(s+1).from).bottom;let f=[],r=[],c=[];const S=()=>{f=[],r=Array.from(l.querySelectorAll(se)),c=r.map(o=>Number(o.dataset.line));const s=[...c],{lines:u}=n.state.doc;let E=s.shift()||0,t=s.shift()||u;for(let o=0;o<u;o++)o===t&&(E=o,t=s.shift()||u),f.push({start:E,end:t-1})},N=(s,u)=>{let E=1;for(let t=r.length-1;t-1>=0;t--){const o=r[t],a=r[t-1];if(o.offsetTop+o.offsetHeight>u&&a.offsetTop<u){E=Number(a.dataset.line);break}}for(let t=f.length-1;t>=0;t--){const o=b(f[t].end),a=m(f[t].start);if(o>s&&a<=s){E=E<f[t].start?E:f[t].start;break}}return E};let $=0,D=0;const R=()=>{if(D!==0)return!1;$++;const{scrollDOM:s,contentHeight:u}=n;let E=B(l,"padding-top");const t=n.lineBlockAtHeight(s.scrollTop),{number:o}=n.state.doc.lineAt(t.from),a=f[o-1];if(!a)return!1;let v=1;const T=l.querySelector(`[data-line="${a.start}"]`)||l.firstElementChild?.firstElementChild,d=l.querySelector(`[data-line="${a.end+1}"]`)||l.lastElementChild?.lastElementChild,i=s.scrollHeight-s.clientHeight,k=l.scrollHeight-l.clientHeight;let h=m(a.start),p=b(a.end),y=T.offsetTop,C=d.offsetTop-y;h===0&&(y=0,T===d?(E=0,p=u-s.offsetHeight,C=k):C=d.offsetTop),v=(s.scrollTop-h)/(p-h);const A=d==l.lastElementChild?.lastElementChild?d.offsetTop+d.clientHeight:d.offsetTop;if(p>=i||A>k){const I=N(i,k);h=m(I),v=(s.scrollTop-h)/(i-h);const W=l.querySelector(`[data-line="${I}"]`);h>0&&W&&(y=W.offsetTop),C=k-y+B(l,"padding-top")}const g=y-E+C*v;H(l,g,()=>{$--})},q=()=>{if($!==0)return;D++;const{scrollDOM:s}=n,u=l.scrollTop,E=l.scrollHeight,t=s.scrollHeight-s.clientHeight,o=l.scrollHeight-l.clientHeight;let a=l.firstElementChild?.firstElementChild,v=l.firstElementChild?.lastElementChild;if(c.length>0){let A=Math.ceil(c[c.length-1]*(u/E)),g=c.findLastIndex(I=>I<=A);g=g===-1?0:g,A=c[g];for(let I=g;I>=0&&I<c.length;)if(r[I].offsetTop>u){if(I-1>=0){I--;continue}A=-1,g=I;break}else{if(I+1<c.length&&r[I+1].offsetTop<u){I++;continue}A=c[I],g=I;break}switch(g){case-1:{a=l.firstElementChild?.firstElementChild,v=r[g];break}case c.length-1:{a=r[g],v=l.firstElementChild?.lastElementChild;break}default:a=r[g],v=r[g+1===r.length?g:g+1]}}let T=a===l.firstElementChild?.firstElementChild?0:a.offsetTop-B(a,"margin-top"),d=v.offsetTop,i=0;const{start:k,end:h}=f[Number(a.dataset.line||0)];let p=m(k);const y=m(h+1===n.state.doc.lines?h:h+1);let C=0;if(y>t||v.offsetTop+v.offsetHeight>o){const A=N(t,o),g=l.querySelector(`[data-line="${A}"]`);T=g?g.offsetTop-B(g,"margin-top"):T,p=m(A),i=(u-T)/(o-T),C=t-p}else a===l.firstElementChild?.firstElementChild?(a===v&&(d=v.offsetTop+v.offsetHeight+ +getComputedStyle(v).marginBottom.replace("px","")),C=y,i=Math.max(u/d,0)):(i=Math.max((u-T)/(d-T),0),C=y-p);H(e,p+C*i,()=>{D--})},M=s=>{const{scrollDOM:u,contentHeight:E}=n,t=u.clientHeight;if(E<=t||l.firstElementChild.clientHeight<=l.clientHeight||n.state.doc.lines<=f[f.length-1]?.end)return!1;s.target===e?R():q()};return[()=>{S(),e.addEventListener("scroll",M),l.addEventListener("scroll",M),e.dispatchEvent(new Event("scroll"))},()=>{e.removeEventListener("scroll",M),l.removeEventListener("scroll",M)}]},re={tocItem:{type:Object,default:()=>({})},mdHeadingId:{type:Function,default:()=>{}},onActive:{type:Function,default:()=>{}},onClick:{type:Function,default:()=>{}},scrollElementOffsetTop:{type:Number,default:0}},K=U({props:re,setup(e){const l=_("scrollElementRef"),x=_("roorNodeRef"),n=F();z(()=>e.tocItem.active,m=>{m&&e.onActive(e.tocItem,n.value)}),J(()=>{e.tocItem.active&&e.onActive(e.tocItem,n.value)});const H=m=>{if(m.stopPropagation(),e.onClick(m,e.tocItem),m.defaultPrevented)return;const b=e.mdHeadingId({text:e.tocItem.text,level:e.tocItem.level,index:e.tocItem.index,currentToken:e.tocItem.currentToken,nextToken:e.tocItem.nextToken}),f=x.value.getElementById(b),r=l.value;if(f&&r){let c=f.offsetParent,S=f.offsetTop;if(r.contains(c))for(;c&&r!=c;)S+=c?.offsetTop,c=c?.offsetParent;const N=f.previousElementSibling;let $=0;N||($=B(f,"margin-top")),r?.scrollTo({top:S-e.scrollElementOffsetTop-$,behavior:"smooth"})}};return()=>L("div",{ref:n,class:[`${w}-catalog-link`,e.tocItem.active&&`${w}-catalog-active`],onClick:H},[L("span",{title:e.tocItem.text},[e.tocItem.text]),e.tocItem.children&&e.tocItem.children.length>0&&L("div",{class:`${w}-catalog-wrapper`},[e.tocItem.children.map(m=>L(K,{mdHeadingId:e.mdHeadingId,key:`${e.tocItem.text}-link-${m.level}-${m.text}`,tocItem:m,onActive:e.onActive,onClick:e.onClick,scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])}}),ce={editorId:{type:String,default:void 0},class:{type:String,default:""},mdHeadingId:{type:Function,default:({text:e})=>e},scrollElement:{type:[String,Object],default:void 0},theme:{type:String,default:"light"},offsetTop:{type:Number,default:20},scrollElementOffsetTop:{type:Number,default:0},onClick:{type:Function,default:void 0},onActive:{type:Function,default:void 0},isScrollElementInShadow:{type:Boolean,default:!1},syncWith:{type:String,default:"preview"},catalogMaxDepth:{type:Number,default:void 0}},P=U({name:"MdCatalog",props:ce,emits:["onClick","onActive"],setup(e,l){const x=e.editorId,n=`#${x}-preview-wrapper`,H=X({list:[],show:!1,scrollElement:e.scrollElement||n}),m=j(),b=F(),f=F(),r=F(),c=F(),S=j(),N=F({});V("scrollElementRef",f),V("roorNodeRef",c);const $=Y(()=>{const t=[];return H.list.forEach((o,a)=>{if(e.catalogMaxDepth&&o.level>e.catalogMaxDepth)return;const{text:v,level:T,line:d}=o,i={level:T,text:v,line:d,index:a+1,active:m.value===o};if(t.length===0)t.push(i);else{let k=t[t.length-1];if(i.level>k.level)for(let h=k.level+1;h<=6;h++){const{children:p}=k;if(!p){k.children=[i];break}if(k=p[p.length-1],i.level<=k.level){p.push(i);break}}else t.push(i)}}),t}),D=()=>{if(H.scrollElement instanceof HTMLElement)return H.scrollElement;let t=document;return(H.scrollElement===n||e.isScrollElementInShadow)&&(t=b.value?.getRootNode()),t.querySelector(H.scrollElement)},R=t=>{if(t.length===0)return m.value=void 0,H.list=[],!1;const{activeHead:o,activeIndex:a}=t.reduce((d,i,k)=>{let h=0;if(e.syncWith==="preview"){const p=c.value?.getElementById(e.mdHeadingId({text:i.text,level:i.level,index:k+1,currentToken:i.currentToken,nextToken:i.nextToken}));p instanceof HTMLElement&&(h=ie(p,f.value))}else{const p=S.value;if(p){const y=p.lineBlockAt(p.state.doc.line(i.line+1).from).top,C=p.scrollDOM.scrollTop;h=y-C}}return h<e.offsetTop&&h>d.minTop?{activeHead:i,activeIndex:k,minTop:h}:d},{activeHead:t[0],activeIndex:0,minTop:Number.MIN_SAFE_INTEGER});let v=o;const{catalogMaxDepth:T}=e;if(T&&v.level>T){for(let d=a;d>=0;d--){const i=t[d];if(i.level<=T){v=i;break}}if(v.level>T){const d=t.find(i=>i.level<=T);d&&(v=d)}}m.value=v,H.list=t},q=(t,o)=>{N.value.top=o.offsetTop+B(o,"padding-top")+"px",e.onActive?.(t,o),l.emit("onActive",t,o)},M=()=>{R(H.list)},s=t=>{if(r.value?.removeEventListener("scroll",M),e.syncWith==="editor")r.value=S.value?.scrollDOM;else{const o=D();f.value=o,r.value=o===document.documentElement?document:o}R(t),r.value?.addEventListener("scroll",M)},u=t=>{S.value=t};z([()=>e.syncWith,S,()=>e.catalogMaxDepth],()=>{s(H.list)}),J(()=>{c.value=b.value.getRootNode(),O.on(x,{name:G,callback:s}),O.on(x,{name:Q,callback:u}),O.emit(x,oe),O.emit(x,ne)}),Z(()=>{O.remove(x,G,s),O.remove(x,Q,u),r.value?.removeEventListener("scroll",M)});const E=(t,o)=>{e.onClick?.(t,o),l.emit("onClick",t,o)};return()=>L("div",{class:[`${w}-catalog`,e.theme==="dark"&&`${w}-catalog-dark`,e.class||""],ref:b},[$.value.length>0&&L(ee,null,[L("div",{class:`${w}-catalog-indicator`,style:N.value},null),L("div",{class:`${w}-catalog-container`},[$.value.map(t=>L(K,{mdHeadingId:e.mdHeadingId,tocItem:t,key:`link-${t.level}-${t.text}`,onActive:q,onClick:E,scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])])}});P.install=e=>(e.component(P.name,P),e);export{P as W,me as g,de as v};
