import{e as Y,q as te,z,r as V,aG as J,A as le,f as Z,s as oe,v as ne,b as x,ae as se,p as B,l as K,B as ie,aH as re,am as ae}from"./CO-tX7bV.js";import{b as W,i as Q,G as X,P as ce,S as de,j as fe}from"./RL_mbjqN.js";const ue=`.${B}-preview > [data-line]`,j=(e,o)=>+getComputedStyle(e).getPropertyValue(o).replace("px",""),Te=(e,o)=>{const p=re(()=>{e.removeEventListener("scroll",n),e.addEventListener("scroll",n),o.removeEventListener("scroll",n),o.addEventListener("scroll",n)},50),n=i=>{const T=e.clientHeight,b=o.clientHeight,f=e.scrollHeight,r=o.scrollHeight,u=(f-T)/(r-b);i.target===e?(o.removeEventListener("scroll",n),o.scrollTo({top:e.scrollTop/u}),p()):(e.removeEventListener("scroll",n),e.scrollTo({top:o.scrollTop*u}),p())};return[()=>{p().finally(()=>{e.dispatchEvent(new Event("scroll"))})},()=>{e.removeEventListener("scroll",n),o.removeEventListener("scroll",n)}]},He=(e,o,p)=>{const{view:n}=p,i=ae(),T=c=>n.lineBlockAt(n.state.doc.line(c+1).from).top,b=c=>n.lineBlockAt(n.state.doc.line(c+1).from).bottom;let f=[],r=[],u=[];const S=()=>{f=[],r=Array.from(o.querySelectorAll(ue)),u=r.map(s=>Number(s.dataset.line));const c=[...u],{lines:g}=n.state.doc;let l=c.shift()||0,t=c.shift()||g;for(let s=0;s<g;s++)s===t&&(l=s,t=c.shift()||g),f.push({start:l,end:t-1})},L=(c,g)=>{let l=1;for(let t=r.length-1;t-1>=0;t--){const s=r[t],m=r[t-1];if(s.offsetTop+s.offsetHeight>g&&m.offsetTop<g){l=Number(m.dataset.line);break}}for(let t=f.length-1;t>=0;t--){const s=b(f[t].end),m=T(f[t].start);if(s>c&&m<=c){l=l<f[t].start?l:f[t].start;break}}return l};let H=0,O=0;const P=()=>{var c,g,l;if(O!==0)return!1;H++;const{scrollDOM:t,contentHeight:s}=n;let m=j(o,"padding-top");const k=n.lineBlockAtHeight(t.scrollTop),{number:C}=n.state.doc.lineAt(k.from),v=f[C-1];if(!v)return!1;let d=1;const I=o.querySelector(`[data-line="${v.start}"]`)||((c=o.firstElementChild)==null?void 0:c.firstElementChild),a=o.querySelector(`[data-line="${v.end+1}"]`)||((g=o.lastElementChild)==null?void 0:g.lastElementChild),E=t.scrollHeight-t.clientHeight,A=o.scrollHeight-o.clientHeight;let _=T(v.start),M=b(v.end),D=I.offsetTop,w=a.offsetTop-D;_===0&&(D=0,I===a?(m=0,M=s-t.offsetHeight,w=A):w=a.offsetTop),d=(t.scrollTop-_)/(M-_);const q=a==((l=o.lastElementChild)==null?void 0:l.lastElementChild)?a.offsetTop+a.clientHeight:a.offsetTop;if(M>=E||q>A){const $=L(E,A);_=T($),d=(t.scrollTop-_)/(E-_);const N=o.querySelector(`[data-line="${$}"]`);_>0&&N&&(D=N.offsetTop),w=A-D+j(o,"padding-top")}const G=D-m+w*d;i(o,G,()=>{H--})},F=()=>{var c,g,l,t,s,m;if(H!==0)return;O++;const{scrollDOM:k}=n,C=o.scrollTop,v=o.scrollHeight,d=k.scrollHeight-k.clientHeight,I=o.scrollHeight-o.clientHeight;let a=(c=o.firstElementChild)==null?void 0:c.firstElementChild,E=(g=o.firstElementChild)==null?void 0:g.lastElementChild;if(u.length>0){let N=Math.ceil(u[u.length-1]*(C/v)),h=u.findLastIndex(y=>y<=N);h=h===-1?0:h,N=u[h];for(let y=h;y>=0&&y<u.length;)if(r[y].offsetTop>C){if(y-1>=0){y--;continue}N=-1,h=y;break}else{if(y+1<u.length&&r[y+1].offsetTop<C){y++;continue}N=u[y],h=y;break}switch(h){case-1:{a=(l=o.firstElementChild)==null?void 0:l.firstElementChild,E=r[h];break}case u.length-1:{a=r[h],E=(t=o.firstElementChild)==null?void 0:t.lastElementChild;break}default:a=r[h],E=r[h+1===r.length?h:h+1]}}let A=a===((s=o.firstElementChild)==null?void 0:s.firstElementChild)?0:a.offsetTop-j(a,"margin-top"),_=E.offsetTop,M=0;const{start:D,end:w}=f[Number(a.dataset.line||0)];let q=T(D);const G=T(w+1===n.state.doc.lines?w:w+1);let $=0;if(G>d||E.offsetTop+E.offsetHeight>I){const N=L(d,I),h=o.querySelector(`[data-line="${N}"]`);A=h?h.offsetTop-j(h,"margin-top"):A,q=T(N),M=(C-A)/(I-A),$=d-q}else a===((m=o.firstElementChild)==null?void 0:m.firstElementChild)?(a===E&&(_=E.offsetTop+E.offsetHeight+ +getComputedStyle(E).marginBottom.replace("px","")),$=G,M=Math.max(C/_,0)):(M=Math.max((C-A)/(_-A),0),$=G-q);i(e,q+$*M,()=>{O--})},R=c=>{var g;const{scrollDOM:l,contentHeight:t}=n,s=l.clientHeight;if(t<=s||o.firstElementChild.clientHeight<=o.clientHeight||n.state.doc.lines<=((g=f[f.length-1])==null?void 0:g.end))return!1;c.target===e?P():F()};return[()=>{S(),e.addEventListener("scroll",R),o.addEventListener("scroll",R),e.dispatchEvent(new Event("scroll"))},()=>{e.removeEventListener("scroll",R),o.removeEventListener("scroll",R)}]},me={tocItem:{type:Object,default:()=>({})},mdHeadingId:{type:Function,default:()=>{}},onActive:{type:Function,default:()=>{}},onClick:{type:Function,default:()=>{}},scrollElementOffsetTop:{type:Number,default:0}},ee=Y({props:me,setup(e){const o=K("scrollElementRef"),p=K("roorNodeRef"),n=V();return Z(()=>e.tocItem.active,i=>{i&&(n.value?e.onActive(e.tocItem,n.value):ie(()=>{e.onActive(e.tocItem,n.value)}))},{immediate:!0}),()=>{const{tocItem:i,mdHeadingId:T,onClick:b,scrollElementOffsetTop:f}=e;return x("div",{ref:n,class:[`${B}-catalog-link`,i.active&&`${B}-catalog-active`],onClick:r=>{if(r.stopPropagation(),b(r,i),r.defaultPrevented)return;const u=T(i.text,i.level,i.index),S=p.value.getElementById(u),L=o.value;if(S&&L){let H=S.offsetParent,O=S.offsetTop;if(L.contains(H))for(;H&&L!=H;)O+=H==null?void 0:H.offsetTop,H=H==null?void 0:H.offsetParent;const P=S.previousElementSibling;let F=0;P||(F=j(S,"margin-top")),L==null||L.scrollTo({top:O-f-F,behavior:"smooth"})}}},[x("span",{title:i.text},[i.text]),i.children&&i.children.length>0&&x("div",{class:`${B}-catalog-wrapper`},[i.children.map(r=>x(ee,{mdHeadingId:T,key:`${i.text}-link-${r.level}-${r.text}`,tocItem:r,onActive:e.onActive,onClick:b,scrollElementOffsetTop:f},null))])])}}}),ve={editorId:{type:String,default:void 0},class:{type:String,default:""},mdHeadingId:{type:Function,default:e=>e},scrollElement:{type:[String,Object],default:void 0},theme:{type:String,default:"light"},offsetTop:{type:Number,default:20},scrollElementOffsetTop:{type:Number,default:0},onClick:{type:Function,default:void 0},onActive:{type:Function,default:void 0},isScrollElementInShadow:{type:Boolean,default:!1},syncWith:{type:String,default:"preview"}},U=Y({name:"MdCatalog",props:ve,emits:["onClick","onActive"],setup(e,o){const p=e.editorId,n=`#${p}-preview-wrapper`,i=te({list:[],show:!1,scrollElement:e.scrollElement||n}),T=z(),b=V(),f=V(),r=V(),u=V(),S=z(),L=V({});J("scrollElementRef",f),J("roorNodeRef",u);const H=le(()=>{const l=[];return i.list.forEach((t,s)=>{const{text:m,level:k,line:C}=t,v={level:k,text:m,line:C,index:s+1,active:T.value===t};if(l.length===0)l.push(v);else{let d=l[l.length-1];if(v.level>d.level)for(let I=d.level+1;I<=6;I++){const{children:a}=d;if(!a){d.children=[v];break}if(d=a[a.length-1],v.level<=d.level){a.push(v);break}}else l.push(v)}}),l}),O=()=>{var l;if(i.scrollElement instanceof HTMLElement)return i.scrollElement;let t=document;return(i.scrollElement===n||e.isScrollElementInShadow)&&(t=(l=b.value)==null?void 0:l.getRootNode()),t.querySelector(i.scrollElement)},P=l=>{if(l.length===0)return T.value=void 0,i.list=[],!1;const{activeHead:t}=l.reduce((s,m,k)=>{var C;let v=0;if(e.syncWith==="preview"){const d=(C=u.value)==null?void 0:C.getElementById(e.mdHeadingId(m.text,m.level,k+1));d instanceof HTMLElement&&(v=fe(d,f.value))}else{const d=S.value;if(d){const I=d.lineBlockAt(d.state.doc.line(m.line+1).from).top,a=d.scrollDOM.scrollTop;v=I-a}}return v<e.offsetTop&&v>s.minTop?{activeHead:m,minTop:v}:s},{activeHead:l[0],minTop:Number.MIN_SAFE_INTEGER});T.value=t,i.list=l},F=(l,t)=>{L.value.top=t.offsetTop+j(t,"padding-top")+"px",e.onActive?e.onActive(l,t):o.emit("onActive",l,t)},R=()=>{P(i.list)},c=l=>{var t,s,m;if((t=r.value)==null||t.removeEventListener("scroll",R),e.syncWith==="editor")r.value=(s=S.value)==null?void 0:s.scrollDOM;else{const k=O();f.value=k,r.value=k===document.documentElement?document:k}P(l),(m=r.value)==null||m.addEventListener("scroll",R)},g=l=>{S.value=l};return Z([()=>e.syncWith,S],()=>{c(i.list)}),oe(()=>{u.value=b.value.getRootNode(),W.on(p,{name:Q,callback:c}),W.on(p,{name:X,callback:g}),W.emit(p,ce),W.emit(p,de)}),ne(()=>{var l;W.remove(p,Q,c),W.remove(p,X,g),(l=r.value)==null||l.removeEventListener("scroll",R)}),()=>x("div",{class:[`${B}-catalog`,e.theme==="dark"&&`${B}-catalog-dark`,e.class||""],ref:b},[H.value.length>0&&x(se,null,[x("div",{class:`${B}-catalog-indicator`,style:L.value},null),x("div",{class:`${B}-catalog-container`},[H.value.map(l=>x(ee,{mdHeadingId:e.mdHeadingId,tocItem:l,key:`link-${l.level}-${l.text}`,onActive:F,onClick:(t,s)=>{e.onClick&&e.onClick(t,s),o.emit("onClick",t,s)},scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])])}});U.install=e=>(e.component(U.name,U),e);export{U as M,Te as a,He as s};
