import{h as U,r as X,s as j,q as B,f as Y,b as M,v as z,j as J,x as Z,F as ee,p as w,l as V,aE as te,ae as le,aF as _}from"#entry";import{F as R,S as G,f as Q,H as oe,u as ne,g as ie}from"./CaH81vPM.js";const se=`.${w}-preview > [data-line]`,q=(e,t)=>+getComputedStyle(e).getPropertyValue(t).replace("px",""),de=(e,t)=>{const k=te(()=>{e.removeEventListener("scroll",s),e.addEventListener("scroll",s),t.removeEventListener("scroll",s),t.addEventListener("scroll",s)},50),s=n=>{const x=e.clientHeight,I=t.clientHeight,p=e.scrollHeight,r=t.scrollHeight,u=(p-x)/(r-I);n.target===e?(t.removeEventListener("scroll",s),t.scrollTo({top:e.scrollTop/u}),k()):(e.removeEventListener("scroll",s),e.scrollTo({top:t.scrollTop*u}),k())};return[()=>{k().finally(()=>{e.dispatchEvent(new Event("scroll"))})},()=>{e.removeEventListener("scroll",s),t.removeEventListener("scroll",s)}]},me=(e,t,k)=>{const{view:s}=k,n=le(),x=c=>s.lineBlockAt(s.state.doc.line(c+1).from).top,I=c=>s.lineBlockAt(s.state.doc.line(c+1).from).bottom;let p=[],r=[],u=[];const C=()=>{p=[],r=Array.from(t.querySelectorAll(se)),u=r.map(f=>Number(f.dataset.line));const c=[...u],{lines:h}=s.state.doc;let l=c.shift()||0,o=c.shift()||h;for(let f=0;f<h;f++)f===o&&(l=f,o=c.shift()||h),p.push({start:l,end:o-1})},$=(c,h)=>{let l=1;for(let o=r.length-1;o-1>=0;o--){const f=r[o],a=r[o-1];if(f.offsetTop+f.offsetHeight>h&&a.offsetTop<h){l=Number(a.dataset.line);break}}for(let o=p.length-1;o>=0;o--){const f=I(p[o].end),a=x(p[o].start);if(f>c&&a<=c){l=l<p[o].start?l:p[o].start;break}}return l};let H=0,N=0;const D=()=>{if(N!==0)return!1;H++;const{scrollDOM:c,contentHeight:h}=s;let l=q(t,"padding-top");const o=s.lineBlockAtHeight(c.scrollTop),{number:f}=s.state.doc.lineAt(o.from),a=p[f-1];if(!a)return!1;let m=1;const v=t.querySelector(`[data-line="${a.start}"]`)||t.firstElementChild?.firstElementChild,i=t.querySelector(`[data-line="${a.end+1}"]`)||t.lastElementChild?.lastElementChild,E=c.scrollHeight-c.clientHeight,y=t.scrollHeight-t.clientHeight;let d=x(a.start),S=I(a.end),b=v.offsetTop,L=i.offsetTop-b;d===0&&(b=0,v===i?(l=0,S=h-c.offsetHeight,L=y):L=i.offsetTop),m=(c.scrollTop-d)/(S-d);const A=i==t.lastElementChild?.lastElementChild?i.offsetTop+i.clientHeight:i.offsetTop;if(S>=E||A>y){const T=$(E,y);d=x(T),m=(c.scrollTop-d)/(E-d);const W=t.querySelector(`[data-line="${T}"]`);d>0&&W&&(b=W.offsetTop),L=y-b+q(t,"padding-top")}const g=b-l+L*m;n(t,g,()=>{H--})},F=()=>{if(H!==0)return;N++;const{scrollDOM:c}=s,h=t.scrollTop,l=t.scrollHeight,o=c.scrollHeight-c.clientHeight,f=t.scrollHeight-t.clientHeight;let a=t.firstElementChild?.firstElementChild,m=t.firstElementChild?.lastElementChild;if(u.length>0){let A=Math.ceil(u[u.length-1]*(h/l)),g=u.findLastIndex(T=>T<=A);g=g===-1?0:g,A=u[g];for(let T=g;T>=0&&T<u.length;)if(r[T].offsetTop>h){if(T-1>=0){T--;continue}A=-1,g=T;break}else{if(T+1<u.length&&r[T+1].offsetTop<h){T++;continue}A=u[T],g=T;break}switch(g){case-1:{a=t.firstElementChild?.firstElementChild,m=r[g];break}case u.length-1:{a=r[g],m=t.firstElementChild?.lastElementChild;break}default:a=r[g],m=r[g+1===r.length?g:g+1]}}let v=a===t.firstElementChild?.firstElementChild?0:a.offsetTop-q(a,"margin-top"),i=m.offsetTop,E=0;const{start:y,end:d}=p[Number(a.dataset.line||0)];let S=x(y);const b=x(d+1===s.state.doc.lines?d:d+1);let L=0;if(b>o||m.offsetTop+m.offsetHeight>f){const A=$(o,f),g=t.querySelector(`[data-line="${A}"]`);v=g?g.offsetTop-q(g,"margin-top"):v,S=x(A),E=(h-v)/(f-v),L=o-S}else a===t.firstElementChild?.firstElementChild?(a===m&&(i=m.offsetTop+m.offsetHeight+ +getComputedStyle(m).marginBottom.replace("px","")),L=b,E=Math.max(h/i,0)):(E=Math.max((h-v)/(i-v),0),L=b-S);n(e,S+L*E,()=>{N--})},O=c=>{const{scrollDOM:h,contentHeight:l}=s,o=h.clientHeight;if(l<=o||t.firstElementChild.clientHeight<=t.clientHeight||s.state.doc.lines<=p[p.length-1]?.end)return!1;c.target===e?D():F()};return[()=>{C(),e.addEventListener("scroll",O),t.addEventListener("scroll",O),e.dispatchEvent(new Event("scroll"))},()=>{e.removeEventListener("scroll",O),t.removeEventListener("scroll",O)}]},re={tocItem:{type:Object,default:()=>({})},mdHeadingId:{type:Function,default:()=>{}},onActive:{type:Function,default:()=>{}},onClick:{type:Function,default:()=>{}},scrollElementOffsetTop:{type:Number,default:0}},K=U({props:re,setup(e){const t=V("scrollElementRef"),k=V("roorNodeRef"),s=B();return z(()=>e.tocItem.active,n=>{n&&e.onActive(e.tocItem,s.value)}),J(()=>{e.tocItem.active&&e.onActive(e.tocItem,s.value)}),()=>{const{tocItem:n,mdHeadingId:x,onClick:I,scrollElementOffsetTop:p}=e;return M("div",{ref:s,class:[`${w}-catalog-link`,n.active&&`${w}-catalog-active`],onClick:r=>{if(r.stopPropagation(),I(r,n),r.defaultPrevented)return;const u=x({text:n.text,level:n.level,index:n.index,currentToken:n.currentToken,nextToken:n.nextToken}),C=k.value.getElementById(u),$=t.value;if(C&&$){let H=C.offsetParent,N=C.offsetTop;if($.contains(H))for(;H&&$!=H;)N+=H?.offsetTop,H=H?.offsetParent;const D=C.previousElementSibling;let F=0;D||(F=q(C,"margin-top")),$?.scrollTo({top:N-p-F,behavior:"smooth"})}}},[M("span",{title:n.text},[n.text]),n.children&&n.children.length>0&&M("div",{class:`${w}-catalog-wrapper`},[n.children.map(r=>M(K,{mdHeadingId:x,key:`${n.text}-link-${r.level}-${r.text}`,tocItem:r,onActive:e.onActive,onClick:I,scrollElementOffsetTop:p},null))])])}}}),ae={editorId:{type:String,default:void 0},class:{type:String,default:""},mdHeadingId:{type:Function,default:({text:e})=>e},scrollElement:{type:[String,Object],default:void 0},theme:{type:String,default:"light"},offsetTop:{type:Number,default:20},scrollElementOffsetTop:{type:Number,default:0},onClick:{type:Function,default:void 0},onActive:{type:Function,default:void 0},isScrollElementInShadow:{type:Boolean,default:!1},syncWith:{type:String,default:"preview"},catalogMaxDepth:{type:Number,default:void 0}},P=U({name:"MdCatalog",props:ae,emits:["onClick","onActive"],setup(e,t){const k=e.editorId,s=`#${k}-preview-wrapper`,n=X({list:[],show:!1,scrollElement:e.scrollElement||s}),x=j(),I=B(),p=B(),r=B(),u=B(),C=j(),$=B({});_("scrollElementRef",p),_("roorNodeRef",u);const H=Y(()=>{const l=[];return n.list.forEach((o,f)=>{if(e.catalogMaxDepth&&o.level>e.catalogMaxDepth)return;const{text:a,level:m,line:v}=o,i={level:m,text:a,line:v,index:f+1,active:x.value===o};if(l.length===0)l.push(i);else{let E=l[l.length-1];if(i.level>E.level)for(let y=E.level+1;y<=6;y++){const{children:d}=E;if(!d){E.children=[i];break}if(E=d[d.length-1],i.level<=E.level){d.push(i);break}}else l.push(i)}}),l}),N=()=>{if(n.scrollElement instanceof HTMLElement)return n.scrollElement;let l=document;return(n.scrollElement===s||e.isScrollElementInShadow)&&(l=I.value?.getRootNode()),l.querySelector(n.scrollElement)},D=l=>{if(l.length===0)return x.value=void 0,n.list=[],!1;const{activeHead:o,activeIndex:f}=l.reduce((v,i,E)=>{let y=0;if(e.syncWith==="preview"){const d=u.value?.getElementById(e.mdHeadingId({text:i.text,level:i.level,index:E+1,currentToken:i.currentToken,nextToken:i.nextToken}));d instanceof HTMLElement&&(y=ie(d,p.value))}else{const d=C.value;if(d){const S=d.lineBlockAt(d.state.doc.line(i.line+1).from).top,b=d.scrollDOM.scrollTop;y=S-b}}return y<e.offsetTop&&y>v.minTop?{activeHead:i,activeIndex:E,minTop:y}:v},{activeHead:l[0],activeIndex:0,minTop:Number.MIN_SAFE_INTEGER});let a=o;const{catalogMaxDepth:m}=e;if(m&&a.level>m){for(let v=f;v>=0;v--){const i=l[v];if(i.level<=m){a=i;break}}if(a.level>m){const v=l.find(i=>i.level<=m);v&&(a=v)}}x.value=a,n.list=l},F=(l,o)=>{$.value.top=o.offsetTop+q(o,"padding-top")+"px",e.onActive?.(l,o),t.emit("onActive",l,o)},O=()=>{D(n.list)},c=l=>{if(r.value?.removeEventListener("scroll",O),e.syncWith==="editor")r.value=C.value?.scrollDOM;else{const o=N();p.value=o,r.value=o===document.documentElement?document:o}D(l),r.value?.addEventListener("scroll",O)},h=l=>{C.value=l};return z([()=>e.syncWith,C,()=>e.catalogMaxDepth],()=>{c(n.list)}),J(()=>{u.value=I.value.getRootNode(),R.on(k,{name:G,callback:c}),R.on(k,{name:Q,callback:h}),R.emit(k,oe),R.emit(k,ne)}),Z(()=>{R.remove(k,G,c),R.remove(k,Q,h),r.value?.removeEventListener("scroll",O)}),()=>M("div",{class:[`${w}-catalog`,e.theme==="dark"&&`${w}-catalog-dark`,e.class||""],ref:I},[H.value.length>0&&M(ee,null,[M("div",{class:`${w}-catalog-indicator`,style:$.value},null),M("div",{class:`${w}-catalog-container`},[H.value.map(l=>M(K,{mdHeadingId:e.mdHeadingId,tocItem:l,key:`link-${l.level}-${l.text}`,onActive:F,onClick:(o,f)=>{e.onClick?.(o,f),t.emit("onClick",o,f)},scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])])}});P.install=e=>(e.component(P.name,P),e);export{P as W,me as g,de as v};
