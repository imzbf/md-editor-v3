import{h as U,r as X,s as j,q as R,f as Y,v as z,j as J,x as Z,b as L,F as ee,p as w,l as _,aE as te,ae as le,aF as V}from"#entry";import{F,S as G,f as Q,H as oe,u as ne,g as se}from"./CaH81vPM.js";const ie=`.${w}-preview > [data-line]`,O=(e,l)=>+getComputedStyle(e).getPropertyValue(l).replace("px",""),de=(e,l)=>{const y=te(()=>{e.removeEventListener("scroll",n),e.addEventListener("scroll",n),l.removeEventListener("scroll",n),l.addEventListener("scroll",n)},50),n=k=>{const m=e.clientHeight,C=l.clientHeight,f=e.scrollHeight,r=l.scrollHeight,c=(f-m)/(r-C);k.target===e?(l.removeEventListener("scroll",n),l.scrollTo({top:e.scrollTop/c}),y()):(e.removeEventListener("scroll",n),e.scrollTo({top:l.scrollTop*c}),y())};return[()=>{y().finally(()=>{e.dispatchEvent(new Event("scroll"))})},()=>{e.removeEventListener("scroll",n),l.removeEventListener("scroll",n)}]},me=(e,l,y)=>{const{view:n}=y,k=le(),m=i=>n.lineBlockAt(n.state.doc.line(i+1).from).top,C=i=>n.lineBlockAt(n.state.doc.line(i+1).from).bottom;let f=[],r=[],c=[];const $=()=>{f=[],r=Array.from(l.querySelectorAll(ie)),c=r.map(o=>Number(o.dataset.line));const i=[...c],{lines:p}=n.state.doc;let E=i.shift()||0,t=i.shift()||p;for(let o=0;o<p;o++)o===t&&(E=o,t=i.shift()||p),f.push({start:E,end:t-1})},N=(i,p)=>{let E=1;for(let t=r.length-1;t-1>=0;t--){const o=r[t],a=r[t-1];if(o.offsetTop+o.offsetHeight>p&&a.offsetTop<p){E=Number(a.dataset.line);break}}for(let t=f.length-1;t>=0;t--){const o=C(f[t].end),a=m(f[t].start);if(o>i&&a<=i){E=E<f[t].start?E:f[t].start;break}}return E};let S=0,B=0;const D=()=>{if(B!==0)return!1;S++;const{scrollDOM:i,contentHeight:p}=n;let E=O(l,"padding-block-start");const t=n.lineBlockAtHeight(i.scrollTop),{number:o}=n.state.doc.lineAt(t.from),a=f[o-1];if(!a)return!1;let v=1;const T=l.querySelector(`[data-line="${a.start}"]`)||l.firstElementChild?.firstElementChild,d=l.querySelector(`[data-line="${a.end+1}"]`)||l.lastElementChild?.lastElementChild,s=i.scrollHeight-i.clientHeight,H=l.scrollHeight-l.clientHeight;let h=m(a.start),u=C(a.end),x=T.offsetTop,b=d.offsetTop-x;h===0&&(x=0,T===d?(E=0,u=p-i.offsetHeight,b=H):b=d.offsetTop),v=(i.scrollTop-h)/(u-h);const A=d==l.lastElementChild?.lastElementChild?d.offsetTop+d.clientHeight:d.offsetTop;if(u>=s||A>H){const I=N(s,H);h=m(I),v=(i.scrollTop-h)/(s-h);const W=l.querySelector(`[data-line="${I}"]`);h>0&&W&&(x=W.offsetTop),b=H-x+O(l,"padding-block-start")}const g=x-E+b*v;k(l,g,()=>{S--})},q=()=>{if(S!==0)return;B++;const{scrollDOM:i}=n,p=l.scrollTop,E=l.scrollHeight,t=i.scrollHeight-i.clientHeight,o=l.scrollHeight-l.clientHeight;let a=l.firstElementChild?.firstElementChild,v=l.firstElementChild?.lastElementChild;if(c.length>0){let A=Math.ceil(c[c.length-1]*(p/E)),g=c.findLastIndex(I=>I<=A);g=g===-1?0:g,A=c[g];for(let I=g;I>=0&&I<c.length;)if(r[I].offsetTop>p){if(I-1>=0){I--;continue}A=-1,g=I;break}else{if(I+1<c.length&&r[I+1].offsetTop<p){I++;continue}A=c[I],g=I;break}switch(g){case-1:{a=l.firstElementChild?.firstElementChild,v=r[g];break}case c.length-1:{a=r[g],v=l.firstElementChild?.lastElementChild;break}default:a=r[g],v=r[g+1===r.length?g:g+1]}}let T=a===l.firstElementChild?.firstElementChild?0:a.offsetTop-O(a,"margin-block-start"),d=v.offsetTop,s=0;const{start:H,end:h}=f[Number(a.dataset.line||0)];let u=m(H);const x=m(h+1===n.state.doc.lines?h:h+1);let b=0;if(x>t||v.offsetTop+v.offsetHeight>o){const A=N(t,o),g=l.querySelector(`[data-line="${A}"]`);T=g?g.offsetTop-O(g,"margin-block-start"):T,u=m(A),s=(p-T)/(o-T),b=t-u}else a===l.firstElementChild?.firstElementChild?(a===v&&(d=v.offsetTop+v.offsetHeight+O(v,"margin-block-end")),b=x,s=Math.max(p/d,0)):(s=Math.max((p-T)/(d-T),0),b=x-u);k(e,u+b*s,()=>{B--})},M=i=>{const{scrollDOM:p,contentHeight:E}=n,t=p.clientHeight;if(E<=t||l.firstElementChild.clientHeight<=l.clientHeight||n.state.doc.lines<=f[f.length-1]?.end)return!1;i.target===e?D():q()};return[()=>{$(),e.addEventListener("scroll",M),l.addEventListener("scroll",M),e.dispatchEvent(new Event("scroll"))},()=>{e.removeEventListener("scroll",M),l.removeEventListener("scroll",M)}]},re={tocItem:{type:Object,default:()=>({})},mdHeadingId:{type:Function,default:()=>{}},onActive:{type:Function,default:()=>{}},onClick:{type:Function,default:()=>{}},scrollElementOffsetTop:{type:Number,default:0}},K=U({props:re,setup(e){const l=_("scrollElementRef"),y=_("roorNodeRef"),n=R();z(()=>e.tocItem.active,m=>{m&&e.onActive(e.tocItem,n.value)}),J(()=>{e.tocItem.active&&e.onActive(e.tocItem,n.value)});const k=m=>{if(m.stopPropagation(),e.onClick(m,e.tocItem),m.defaultPrevented)return;const C=e.mdHeadingId({text:e.tocItem.text,level:e.tocItem.level,index:e.tocItem.index,currentToken:e.tocItem.currentToken,nextToken:e.tocItem.nextToken}),f=y.value.getElementById(C),r=l.value;if(f&&r){let c=f.offsetParent,$=f.offsetTop;if(r.contains(c))for(;c&&r!=c;)$+=c?.offsetTop,c=c?.offsetParent;const N=f.previousElementSibling;let S=0;N||(S=O(f,"margin-block-start")),r?.scrollTo({top:$-e.scrollElementOffsetTop-S,behavior:"smooth"})}};return()=>L("div",{ref:n,class:[`${w}-catalog-link`,e.tocItem.active&&`${w}-catalog-active`],onClick:k},[L("span",{title:e.tocItem.text},[e.tocItem.text]),e.tocItem.children&&e.tocItem.children.length>0&&L("div",{class:`${w}-catalog-wrapper`},[e.tocItem.children.map(m=>L(K,{mdHeadingId:e.mdHeadingId,key:`${e.tocItem.text}-link-${m.level}-${m.text}`,tocItem:m,onActive:e.onActive,onClick:e.onClick,scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])}}),ce={editorId:{type:String,default:void 0},class:{type:String,default:""},mdHeadingId:{type:Function,default:({text:e})=>e},scrollElement:{type:[String,Object],default:void 0},theme:{type:String,default:"light"},offsetTop:{type:Number,default:20},scrollElementOffsetTop:{type:Number,default:0},onClick:{type:Function,default:void 0},onActive:{type:Function,default:void 0},isScrollElementInShadow:{type:Boolean,default:!1},syncWith:{type:String,default:"preview"},catalogMaxDepth:{type:Number,default:void 0}},P=U({name:"MdCatalog",props:ce,emits:["onClick","onActive"],setup(e,l){const y=e.editorId,n=`#${y}-preview-wrapper`,k=X({list:[],show:!1,scrollElement:e.scrollElement||n}),m=j(),C=R(),f=R(),r=R(),c=R(),$=j(),N=R({});V("scrollElementRef",f),V("roorNodeRef",c);const S=Y(()=>{const t=[];return k.list.forEach((o,a)=>{if(e.catalogMaxDepth&&o.level>e.catalogMaxDepth)return;const{text:v,level:T,line:d}=o,s={level:T,text:v,line:d,index:a+1,active:m.value===o};if(t.length===0)t.push(s);else{let H=t[t.length-1];if(s.level>H.level)for(let h=H.level+1;h<=6;h++){const{children:u}=H;if(!u){H.children=[s];break}if(H=u[u.length-1],s.level<=H.level){u.push(s);break}}else t.push(s)}}),t}),B=()=>{if(k.scrollElement instanceof HTMLElement)return k.scrollElement;let t=document;return(k.scrollElement===n||e.isScrollElementInShadow)&&(t=C.value?.getRootNode()),t.querySelector(k.scrollElement)},D=t=>{if(t.length===0)return m.value=void 0,k.list=[],!1;const{activeHead:o,activeIndex:a}=t.reduce((d,s,H)=>{let h=0;if(e.syncWith==="preview"){const u=c.value?.getElementById(e.mdHeadingId({text:s.text,level:s.level,index:H+1,currentToken:s.currentToken,nextToken:s.nextToken}));u instanceof HTMLElement&&(h=se(u,f.value))}else{const u=$.value;if(u){const x=u.lineBlockAt(u.state.doc.line(s.line+1).from).top,b=u.scrollDOM.scrollTop;h=x-b}}return h<e.offsetTop&&h>d.minTop?{activeHead:s,activeIndex:H,minTop:h}:d},{activeHead:t[0],activeIndex:0,minTop:Number.MIN_SAFE_INTEGER});let v=o;const{catalogMaxDepth:T}=e;if(T&&v.level>T){for(let d=a;d>=0;d--){const s=t[d];if(s.level<=T){v=s;break}}if(v.level>T){const d=t.find(s=>s.level<=T);d&&(v=d)}}m.value=v,k.list=t},q=(t,o)=>{N.value.top=o.offsetTop+O(o,"padding-block-start")+"px",e.onActive?.(t,o),l.emit("onActive",t,o)},M=()=>{D(k.list)},i=t=>{if(r.value?.removeEventListener("scroll",M),e.syncWith==="editor")r.value=$.value?.scrollDOM;else{const o=B();f.value=o,r.value=o===document.documentElement?document:o}D(t),r.value?.addEventListener("scroll",M)},p=t=>{$.value=t};z([()=>e.syncWith,$,()=>e.catalogMaxDepth],()=>{i(k.list)}),J(()=>{c.value=C.value.getRootNode(),F.on(y,{name:G,callback:i}),F.on(y,{name:Q,callback:p}),F.emit(y,oe),F.emit(y,ne)}),Z(()=>{F.remove(y,G,i),F.remove(y,Q,p),r.value?.removeEventListener("scroll",M)});const E=(t,o)=>{e.onClick?.(t,o),l.emit("onClick",t,o)};return()=>L("div",{class:[`${w}-catalog`,e.theme==="dark"&&`${w}-catalog-dark`,e.class||""],ref:C},[S.value.length>0&&L(ee,null,[L("div",{class:`${w}-catalog-indicator`,style:N.value},null),L("div",{class:`${w}-catalog-container`},[S.value.map(t=>L(K,{mdHeadingId:e.mdHeadingId,tocItem:t,key:`link-${t.level}-${t.text}`,onActive:q,onClick:E,scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])])}});P.install=e=>(e.component(P.name,P),e);export{P as W,me as h,de as v};
