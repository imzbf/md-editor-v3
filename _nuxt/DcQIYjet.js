import{h as U,r as X,s as j,q as B,f as Y,b as A,v as z,j as J,x as Z,F as ee,p as O,l as V,aE as te,ae as le,aF as _}from"#entry";import{F as R,S as G,f as Q,H as oe,u as ne,g as se}from"./CaH81vPM.js";const ie=`.${O}-preview > [data-line]`,q=(e,t)=>+getComputedStyle(e).getPropertyValue(t).replace("px",""),de=(e,t)=>{const k=te(()=>{e.removeEventListener("scroll",i),e.addEventListener("scroll",i),t.removeEventListener("scroll",i),t.addEventListener("scroll",i)},50),i=n=>{const y=e.clientHeight,C=t.clientHeight,d=e.scrollHeight,r=t.scrollHeight,m=(d-y)/(r-C);n.target===e?(t.removeEventListener("scroll",i),t.scrollTo({top:e.scrollTop/m}),k()):(e.removeEventListener("scroll",i),e.scrollTo({top:t.scrollTop*m}),k())};return[()=>{k().finally(()=>{e.dispatchEvent(new Event("scroll"))})},()=>{e.removeEventListener("scroll",i),t.removeEventListener("scroll",i)}]},me=(e,t,k)=>{const{view:i}=k,n=le(),y=a=>i.lineBlockAt(i.state.doc.line(a+1).from).top,C=a=>i.lineBlockAt(i.state.doc.line(a+1).from).bottom;let d=[],r=[],m=[];const x=()=>{d=[],r=Array.from(t.querySelectorAll(ie)),m=r.map(f=>Number(f.dataset.line));const a=[...m],{lines:p}=i.state.doc;let l=a.shift()||0,o=a.shift()||p;for(let f=0;f<p;f++)f===o&&(l=f,o=a.shift()||p),d.push({start:l,end:o-1})},I=(a,p)=>{let l=1;for(let o=r.length-1;o-1>=0;o--){const f=r[o],s=r[o-1];if(f.offsetTop+f.offsetHeight>p&&s.offsetTop<p){l=Number(s.dataset.line);break}}for(let o=d.length-1;o>=0;o--){const f=C(d[o].end),s=y(d[o].start);if(f>a&&s<=a){l=l<d[o].start?l:d[o].start;break}}return l};let H=0,M=0;const F=()=>{if(M!==0)return!1;H++;const{scrollDOM:a,contentHeight:p}=i;let l=q(t,"padding-top");const o=i.lineBlockAtHeight(a.scrollTop),{number:f}=i.state.doc.lineAt(o.from),s=d[f-1];if(!s)return!1;let v=1;const h=t.querySelector(`[data-line="${s.start}"]`)||t.firstElementChild?.firstElementChild,c=t.querySelector(`[data-line="${s.end+1}"]`)||t.lastElementChild?.lastElementChild,g=a.scrollHeight-a.clientHeight,b=t.scrollHeight-t.clientHeight;let E=y(s.start),N=C(s.end),$=h.offsetTop,S=c.offsetTop-$;E===0&&($=0,h===c?(l=0,N=p-a.offsetHeight,S=b):S=c.offsetTop),v=(a.scrollTop-E)/(N-E);const L=c==t.lastElementChild?.lastElementChild?c.offsetTop+c.clientHeight:c.offsetTop;if(N>=g||L>b){const T=I(g,b);E=y(T),v=(a.scrollTop-E)/(g-E);const W=t.querySelector(`[data-line="${T}"]`);E>0&&W&&($=W.offsetTop),S=b-$+q(t,"padding-top")}const u=$-l+S*v;n(t,u,()=>{H--})},D=()=>{if(H!==0)return;M++;const{scrollDOM:a}=i,p=t.scrollTop,l=t.scrollHeight,o=a.scrollHeight-a.clientHeight,f=t.scrollHeight-t.clientHeight;let s=t.firstElementChild?.firstElementChild,v=t.firstElementChild?.lastElementChild;if(m.length>0){let L=Math.ceil(m[m.length-1]*(p/l)),u=m.findLastIndex(T=>T<=L);u=u===-1?0:u,L=m[u];for(let T=u;T>=0&&T<m.length;)if(r[T].offsetTop>p){if(T-1>=0){T--;continue}L=-1,u=T;break}else{if(T+1<m.length&&r[T+1].offsetTop<p){T++;continue}L=m[T],u=T;break}switch(u){case-1:{s=t.firstElementChild?.firstElementChild,v=r[u];break}case m.length-1:{s=r[u],v=t.firstElementChild?.lastElementChild;break}default:s=r[u],v=r[u+1===r.length?u:u+1]}}let h=s===t.firstElementChild?.firstElementChild?0:s.offsetTop-q(s,"margin-top"),c=v.offsetTop,g=0;const{start:b,end:E}=d[Number(s.dataset.line||0)];let N=y(b);const $=y(E+1===i.state.doc.lines?E:E+1);let S=0;if($>o||v.offsetTop+v.offsetHeight>f){const L=I(o,f),u=t.querySelector(`[data-line="${L}"]`);h=u?u.offsetTop-q(u,"margin-top"):h,N=y(L),g=(p-h)/(f-h),S=o-N}else s===t.firstElementChild?.firstElementChild?(s===v&&(c=v.offsetTop+v.offsetHeight+ +getComputedStyle(v).marginBottom.replace("px","")),S=$,g=Math.max(p/c,0)):(g=Math.max((p-h)/(c-h),0),S=$-N);n(e,N+S*g,()=>{M--})},w=a=>{const{scrollDOM:p,contentHeight:l}=i,o=p.clientHeight;if(l<=o||t.firstElementChild.clientHeight<=t.clientHeight||i.state.doc.lines<=d[d.length-1]?.end)return!1;a.target===e?F():D()};return[()=>{x(),e.addEventListener("scroll",w),t.addEventListener("scroll",w),e.dispatchEvent(new Event("scroll"))},()=>{e.removeEventListener("scroll",w),t.removeEventListener("scroll",w)}]},re={tocItem:{type:Object,default:()=>({})},mdHeadingId:{type:Function,default:()=>{}},onActive:{type:Function,default:()=>{}},onClick:{type:Function,default:()=>{}},scrollElementOffsetTop:{type:Number,default:0}},K=U({props:re,setup(e){const t=V("scrollElementRef"),k=V("roorNodeRef"),i=B();return z(()=>e.tocItem.active,n=>{n&&e.onActive(e.tocItem,i.value)}),J(()=>{e.tocItem.active&&e.onActive(e.tocItem,i.value)}),()=>{const{tocItem:n,mdHeadingId:y,onClick:C,scrollElementOffsetTop:d}=e;return A("div",{ref:i,class:[`${O}-catalog-link`,n.active&&`${O}-catalog-active`],onClick:r=>{if(r.stopPropagation(),C(r,n),r.defaultPrevented)return;const m=y({text:n.text,level:n.level,index:n.index,currentToken:n.currentToken,nextToken:n.nextToken}),x=k.value.getElementById(m),I=t.value;if(x&&I){let H=x.offsetParent,M=x.offsetTop;if(I.contains(H))for(;H&&I!=H;)M+=H?.offsetTop,H=H?.offsetParent;const F=x.previousElementSibling;let D=0;F||(D=q(x,"margin-top")),I?.scrollTo({top:M-d-D,behavior:"smooth"})}}},[A("span",{title:n.text},[n.text]),n.children&&n.children.length>0&&A("div",{class:`${O}-catalog-wrapper`},[n.children.map(r=>A(K,{mdHeadingId:y,key:`${n.text}-link-${r.level}-${r.text}`,tocItem:r,onActive:e.onActive,onClick:C,scrollElementOffsetTop:d},null))])])}}}),ae={editorId:{type:String,default:void 0},class:{type:String,default:""},mdHeadingId:{type:Function,default:({text:e})=>e},scrollElement:{type:[String,Object],default:void 0},theme:{type:String,default:"light"},offsetTop:{type:Number,default:20},scrollElementOffsetTop:{type:Number,default:0},onClick:{type:Function,default:void 0},onActive:{type:Function,default:void 0},isScrollElementInShadow:{type:Boolean,default:!1},syncWith:{type:String,default:"preview"},catalogMaxDepth:{type:Number,default:void 0}},P=U({name:"MdCatalog",props:ae,emits:["onClick","onActive"],setup(e,t){const k=e.editorId,i=`#${k}-preview-wrapper`,n=X({list:[],show:!1,scrollElement:e.scrollElement||i}),y=j(),C=B(),d=B(),r=B(),m=B(),x=j(),I=B({});_("scrollElementRef",d),_("roorNodeRef",m);const H=Y(()=>{const l=[];return n.list.forEach((o,f)=>{if(e.catalogMaxDepth&&o.level>e.catalogMaxDepth)return;const{text:s,level:v,line:h}=o,c={level:v,text:s,line:h,index:f+1,active:y.value===o};if(l.length===0)l.push(c);else{let g=l[l.length-1];if(c.level>g.level)for(let b=g.level+1;b<=6;b++){const{children:E}=g;if(!E){g.children=[c];break}if(g=E[E.length-1],c.level<=g.level){E.push(c);break}}else l.push(c)}}),l}),M=()=>{if(n.scrollElement instanceof HTMLElement)return n.scrollElement;let l=document;return(n.scrollElement===i||e.isScrollElementInShadow)&&(l=C.value?.getRootNode()),l.querySelector(n.scrollElement)},F=l=>{if(l.length===0)return y.value=void 0,n.list=[],!1;const{activeHead:o}=l.reduce((f,s,v)=>{let h=0;if(e.syncWith==="preview"){const c=m.value?.getElementById(e.mdHeadingId({text:s.text,level:s.level,index:v+1,currentToken:s.currentToken,nextToken:s.nextToken}));c instanceof HTMLElement&&(h=se(c,d.value))}else{const c=x.value;if(c){const g=c.lineBlockAt(c.state.doc.line(s.line+1).from).top,b=c.scrollDOM.scrollTop;h=g-b}}return h<e.offsetTop&&h>f.minTop?{activeHead:s,minTop:h}:f},{activeHead:l[0],minTop:Number.MIN_SAFE_INTEGER});y.value=o,n.list=l},D=(l,o)=>{I.value.top=o.offsetTop+q(o,"padding-top")+"px",e.onActive?.(l,o),t.emit("onActive",l,o)},w=()=>{F(n.list)},a=l=>{if(r.value?.removeEventListener("scroll",w),e.syncWith==="editor")r.value=x.value?.scrollDOM;else{const o=M();d.value=o,r.value=o===document.documentElement?document:o}F(l),r.value?.addEventListener("scroll",w)},p=l=>{x.value=l};return z([()=>e.syncWith,x,()=>e.catalogMaxDepth],()=>{a(n.list)}),J(()=>{m.value=C.value.getRootNode(),R.on(k,{name:G,callback:a}),R.on(k,{name:Q,callback:p}),R.emit(k,oe),R.emit(k,ne)}),Z(()=>{R.remove(k,G,a),R.remove(k,Q,p),r.value?.removeEventListener("scroll",w)}),()=>A("div",{class:[`${O}-catalog`,e.theme==="dark"&&`${O}-catalog-dark`,e.class||""],ref:C},[H.value.length>0&&A(ee,null,[A("div",{class:`${O}-catalog-indicator`,style:I.value},null),A("div",{class:`${O}-catalog-container`},[H.value.map(l=>A(K,{mdHeadingId:e.mdHeadingId,tocItem:l,key:`link-${l.level}-${l.text}`,onActive:D,onClick:(o,f)=>{e.onClick?.(o,f),t.emit("onClick",o,f)},scrollElementOffsetTop:e.scrollElementOffsetTop},null))])])])}});P.install=e=>(e.component(P.name,P),e);export{P as W,me as g,de as v};
